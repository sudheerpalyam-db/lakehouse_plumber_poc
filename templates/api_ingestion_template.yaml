# API Ingestion Template
# Reusable template for ingesting data from REST APIs

name: api_ingestion_template
description: "Template for ingesting JSON data from REST APIs into Bronze layer"

parameters:
  - name: table_name
    required: true
    description: "Name of the target table"

  - name: api_url
    required: true
    description: "REST API endpoint URL"

  - name: api_description
    required: false
    default: "API data source"
    description: "Description of the API data"

actions:
  # Load action - Fetch data from API using Python
  - name: load_{{ table_name }}_api
    type: load
    readMode: batch
    source:
      type: python
      description: "Fetch {{ table_name }} data from REST API"
    target: v_{{ table_name }}_raw

  # Transform action - Add operational metadata
  - name: transform_{{ table_name }}_metadata
    type: transform
    transform_type: schema
    source: v_{{ table_name }}_raw
    target: v_{{ table_name }}_enriched
    metadata_columns:
      - name: _ingestion_timestamp
        expression: "current_timestamp()"
      - name: _source_api
        expression: "lit('{{ api_url }}')"
      - name: _record_hash
        expression: "xxhash64(*)"

  # Write action - Create table (batch mode for API)
  - name: write_{{ table_name }}_bronze
    type: write
    source: v_{{ table_name }}_enriched
    write_target:
      type: materialized_view
      database: "{catalog}.{bronze_schema}"
      table: "{{ table_name }}"
      properties:
        delta.autoOptimize.optimizeWrite: "true"
    description: "Write {{ table_name }} from API to bronze layer"
