# Orders Data Transformation - Silver Layer
# Enriches order data with product and customer information

pipeline: silver_transforms
flowgroup: orders_transforms

actions:
  # Load orders from bronze layer
  - name: load_orders_bronze
    type: load
    readMode: stream
    source:
      type: delta
      database: "{catalog}.{bronze_schema}"
      table: orders
    target: v_orders_bronze
    description: "Read orders from bronze layer"

  # Load products for enrichment (batch mode for dimension)
  - name: load_products_bronze
    type: load
    readMode: batch
    source:
      type: delta
      database: "{catalog}.{bronze_schema}"
      table: products
    target: v_products_dim
    description: "Read products dimension for enrichment"

  # Load customers for enrichment (batch mode for dimension)
  - name: load_customers_silver
    type: load
    readMode: batch
    source:
      type: delta
      database: "{catalog}.{silver_schema}"
      table: customers
    target: v_customers_dim
    description: "Read customers dimension for enrichment"

  # Enrich orders with product and customer data
  - name: transform_orders_enrich
    type: transform
    transform_type: sql
    source: v_orders_bronze
    target: v_orders_enriched
    sql: |
      SELECT
        o.order_id,
        o.customer_id,
        c.first_name AS customer_first_name,
        c.last_name AS customer_last_name,
        c.email AS customer_email,
        o.product_id,
        p.product_name,
        p.category AS product_category,
        CAST(o.quantity AS INT) AS quantity,
        CAST(o.unit_price AS DECIMAL(10,2)) AS unit_price,
        CAST(o.quantity AS INT) * CAST(o.unit_price AS DECIMAL(10,2)) AS total_amount,
        CAST(o.order_date AS TIMESTAMP) AS order_date,
        o.status AS order_status,
        o._record_hash AS bronze_record_hash,
        o._processing_timestamp AS bronze_processing_timestamp
      FROM STREAM(v_orders_bronze) o
      LEFT JOIN v_products_dim p ON o.product_id = p.product_id
      LEFT JOIN v_customers_dim c ON o.customer_id = c.customer_id

  # Add silver audit metadata
  - name: transform_orders_audit
    type: transform
    transform_type: schema
    source: v_orders_enriched
    target: v_orders_silver
    metadata_columns:
      - name: _silver_record_hash
        expression: "xxhash64(*)"
      - name: _silver_processing_timestamp
        expression: "current_timestamp()"

  # Data quality checks
  - name: validate_orders_silver
    type: transform
    transform_type: data_quality
    source: v_orders_silver
    target: v_orders_validated
    expectations:
      - name: valid_order_id
        column: order_id
        expectation: not_null
        action: fail
      - name: valid_quantity
        column: quantity
        expectation: range
        min: 1
        max: 10000
        action: warn
      - name: valid_total_amount
        column: total_amount
        expectation: range
        min: 0
        action: warn

  # Write to silver streaming table
  - name: write_orders_silver
    type: write
    source: v_orders_validated
    write_target:
      type: streaming_table
      database: "{catalog}.{silver_schema}"
      table: orders_enriched
      properties:
        delta.autoOptimize.optimizeWrite: "true"
        delta.enableChangeDataFeed: "true"
    description: "Write enriched orders to silver layer"
