# Customer Data Transformation - Silver Layer
# Cleans and standardizes customer data from bronze layer

pipeline: silver_transforms
flowgroup: customer_transforms

actions:
  # Load from bronze layer
  - name: load_customers_bronze
    type: load
    readMode: stream
    source:
      type: delta
      database: "{catalog}.{bronze_schema}"
      table: customers
    target: v_customers_bronze
    description: "Read customers from bronze layer"

  # Data cleansing and standardization
  - name: transform_customers_clean
    type: transform
    transform_type: sql
    source: v_customers_bronze
    target: v_customers_cleaned
    sql: |
      SELECT
        customer_id,
        TRIM(UPPER(first_name)) AS first_name,
        TRIM(UPPER(last_name)) AS last_name,
        LOWER(TRIM(email)) AS email,
        REGEXP_REPLACE(phone, '[^0-9]', '') AS phone_normalized,
        TRIM(address) AS address,
        TRIM(UPPER(city)) AS city,
        TRIM(UPPER(state)) AS state,
        TRIM(zip_code) AS zip_code,
        TRIM(UPPER(country)) AS country,
        CAST(created_date AS TIMESTAMP) AS created_date,
        _record_hash,
        _source_file_path,
        _processing_timestamp AS bronze_processing_timestamp
      FROM STREAM(v_customers_bronze)
      WHERE customer_id IS NOT NULL

  # Add silver layer audit columns
  - name: transform_customers_audit
    type: transform
    transform_type: schema
    source: v_customers_cleaned
    target: v_customers_silver
    metadata_columns:
      - name: _silver_record_hash
        expression: "xxhash64(*)"
      - name: _silver_processing_timestamp
        expression: "current_timestamp()"

  # Data quality expectations
  - name: validate_customers_silver
    type: transform
    transform_type: data_quality
    source: v_customers_silver
    target: v_customers_validated
    expectations:
      - name: valid_customer_id
        column: customer_id
        expectation: not_null
        action: fail
      - name: valid_email_format
        column: email
        expectation: regex
        pattern: "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
        action: warn
      - name: unique_customer_id
        column: customer_id
        expectation: unique
        action: warn

  # Write to silver streaming table
  - name: write_customers_silver
    type: write
    source: v_customers_validated
    write_target:
      type: streaming_table
      database: "{catalog}.{silver_schema}"
      table: customers
      properties:
        delta.autoOptimize.optimizeWrite: "true"
        delta.enableChangeDataFeed: "true"
        delta.deletedFileRetentionDuration: "7 days"
    description: "Write cleaned customers to silver layer"
