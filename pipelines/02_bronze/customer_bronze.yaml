# Bronze layer: Load and cleanse customers from raw schema
pipeline: bronze_load
flowgroup: customer_bronze

presets:
  - bronze_layer

actions:
  - name: customer_raw_load
    type: load
    operational_metadata: ["_processing_timestamp"]
    readMode: stream
    source:
      type: delta
      database: "{catalog}.{raw_schema}"
      table: customers
    target: v_customer_raw
    description: "Load customers table from raw schema"

  - name: customer_bronze_cleanse
    type: transform
    transform_type: sql
    source: v_customer_raw
    target: v_customer_bronze_cleaned
    sql: |
      SELECT
        customer_id,
        first_name,
        last_name,
        email,
        phone,
        address,
        city,
        state,
        country,
        postal_code,
        created_date,
        _source_file_path,
        _source_file_size,
        _source_file_modification_time,
        _record_hash,
        _processing_timestamp
      FROM stream(v_customer_raw)
      WHERE customer_id IS NOT NULL

  - name: write_customer_bronze
    type: write
    source: v_customer_bronze_cleaned
    write_target:
      type: streaming_table
      database: "{catalog}.{bronze_schema}"
      table: "customers"
      table_properties:
        layer: bronze
        source: raw_data.customers
