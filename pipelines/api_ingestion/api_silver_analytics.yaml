# API Data Silver Layer Analytics
# Enriched views combining users, posts, comments, and todos

pipeline: api_analytics
flowgroup: api_silver_analytics

description: "Silver layer analytics combining API data sources"

actions:
  # User Activity Summary - Posts per user
  - name: transform_user_posts_summary
    type: transform
    transform_type: sql
    source:
      - api_users
      - api_posts
    target: v_user_posts_summary
    sql: |
      SELECT
        u.user_id,
        u.name,
        u.username,
        u.email,
        u.company_name,
        u.address_city,
        COUNT(p.post_id) AS total_posts,
        AVG(p.word_count) AS avg_post_word_count,
        SUM(p.content_length) AS total_content_length
      FROM api_users u
      LEFT JOIN api_posts p ON u.user_id = p.user_id
      GROUP BY u.user_id, u.name, u.username, u.email,
               u.company_name, u.address_city

  # Post Engagement - Comments per post
  - name: transform_post_engagement
    type: transform
    transform_type: sql
    source:
      - api_posts
      - api_comments
    target: v_post_engagement
    sql: |
      SELECT
        p.post_id,
        p.user_id,
        p.title,
        p.word_count,
        COUNT(c.comment_id) AS comment_count,
        COUNT(DISTINCT c.email_domain) AS unique_domains
      FROM api_posts p
      LEFT JOIN api_comments c ON p.post_id = c.post_id
      GROUP BY p.post_id, p.user_id, p.title, p.word_count

  # User Productivity - Todos completion rate
  - name: transform_user_productivity
    type: transform
    transform_type: sql
    source:
      - api_users
      - api_todos
    target: v_user_productivity
    sql: |
      SELECT
        u.user_id,
        u.name,
        u.company_name,
        COUNT(t.todo_id) AS total_todos,
        SUM(CASE WHEN t.is_completed THEN 1 ELSE 0 END) AS completed_todos,
        ROUND(SUM(CASE WHEN t.is_completed THEN 1 ELSE 0 END) * 100.0 /
              NULLIF(COUNT(t.todo_id), 0), 2) AS completion_rate
      FROM api_users u
      LEFT JOIN api_todos t ON u.user_id = t.user_id
      GROUP BY u.user_id, u.name, u.company_name
