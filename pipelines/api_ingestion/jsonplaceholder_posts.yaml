# JSONPlaceholder Posts API Ingestion - Bronze Layer
# Ingests blog posts data from the public JSONPlaceholder API

pipeline: api_ingestion
flowgroup: posts_ingestion

api_config:
  base_url: "https://jsonplaceholder.typicode.com"
  endpoint: "/posts"
  format: json

actions:
  # Load posts from JSONPlaceholder API
  - name: load_api_posts
    type: load
    readMode: batch
    source:
      type: python
      api_url: "https://jsonplaceholder.typicode.com/posts"
      description: "Fetch posts from JSONPlaceholder REST API"
    target: v_api_posts_raw

  # Transform posts data
  - name: transform_posts_clean
    type: transform
    transform_type: sql
    source: v_api_posts_raw
    target: v_api_posts_cleaned
    sql: |
      SELECT
        id AS post_id,
        userId AS user_id,
        title,
        body AS content,
        LENGTH(body) AS content_length,
        SIZE(SPLIT(body, ' ')) AS word_count
      FROM v_api_posts_raw

  # Add audit metadata
  - name: transform_posts_metadata
    type: transform
    transform_type: schema
    source: v_api_posts_cleaned
    target: v_api_posts_enriched
    metadata_columns:
      - name: _ingestion_timestamp
        expression: "current_timestamp()"
      - name: _source_api
        expression: "lit('jsonplaceholder.typicode.com/posts')"
      - name: _record_hash
        expression: "xxhash64(*)"

  # Write to bronze table
  - name: write_api_posts_bronze
    type: write
    source: v_api_posts_enriched
    write_target:
      type: table
      database: "{catalog}.{bronze_schema}"
      table: api_posts
    description: "Blog posts from JSONPlaceholder API"
