# JSONPlaceholder Users API Ingestion - Bronze Layer
# Ingests user data from the public JSONPlaceholder API

pipeline: api_ingestion
flowgroup: users_ingestion

# API Source Configuration
api_config:
  base_url: "https://jsonplaceholder.typicode.com"
  endpoint: "/users"
  format: json

actions:
  # Load users from JSONPlaceholder API
  - name: load_api_users
    type: load
    readMode: batch
    source:
      type: python
      api_url: "https://jsonplaceholder.typicode.com/users"
      description: "Fetch users from JSONPlaceholder REST API"
    target: v_api_users_raw

  # Flatten nested JSON structure
  - name: transform_users_flatten
    type: transform
    transform_type: sql
    source: v_api_users_raw
    target: v_api_users_flattened
    sql: |
      SELECT
        id AS user_id,
        name,
        username,
        email,
        phone,
        website,
        address.street AS address_street,
        address.suite AS address_suite,
        address.city AS address_city,
        address.zipcode AS address_zipcode,
        address.geo.lat AS geo_lat,
        address.geo.lng AS geo_lng,
        company.name AS company_name,
        company.catchPhrase AS company_catchphrase,
        company.bs AS company_bs
      FROM v_api_users_raw

  # Add audit metadata
  - name: transform_users_metadata
    type: transform
    transform_type: schema
    source: v_api_users_flattened
    target: v_api_users_enriched
    metadata_columns:
      - name: _ingestion_timestamp
        expression: "current_timestamp()"
      - name: _source_api
        expression: "lit('jsonplaceholder.typicode.com/users')"
      - name: _record_hash
        expression: "xxhash64(*)"

  # Write to bronze table
  - name: write_api_users_bronze
    type: write
    source: v_api_users_enriched
    write_target:
      type: table
      database: "{catalog}.{bronze_schema}"
      table: api_users
    description: "Users from JSONPlaceholder API"
