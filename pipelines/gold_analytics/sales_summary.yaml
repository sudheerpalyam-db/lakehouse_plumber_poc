# Sales Summary Analytics - Gold Layer
# Creates aggregated sales metrics for business analytics

pipeline: gold_analytics
flowgroup: sales_analytics

actions:
  # Load enriched orders from silver layer
  - name: load_orders_silver
    type: load
    readMode: batch
    source:
      type: delta
      database: "{catalog}.{silver_schema}"
      table: orders_enriched
    target: v_orders_silver
    description: "Read enriched orders from silver layer"

  # Daily sales summary aggregation
  - name: transform_daily_sales
    type: transform
    transform_type: sql
    source: v_orders_silver
    target: v_daily_sales_summary
    sql: |
      SELECT
        DATE(order_date) AS sale_date,
        product_category,
        COUNT(DISTINCT order_id) AS total_orders,
        COUNT(DISTINCT customer_id) AS unique_customers,
        SUM(quantity) AS total_units_sold,
        SUM(total_amount) AS total_revenue,
        AVG(total_amount) AS avg_order_value,
        MIN(total_amount) AS min_order_value,
        MAX(total_amount) AS max_order_value
      FROM v_orders_silver
      GROUP BY DATE(order_date), product_category

  # Write as materialized view
  - name: write_daily_sales_summary
    type: write
    source: v_daily_sales_summary
    write_target:
      type: materialized_view
      database: "{catalog}.{gold_schema}"
      table: daily_sales_summary
      properties:
        delta.autoOptimize.optimizeWrite: "true"
    description: "Daily sales summary materialized view"
