# Customer 360 Analytics - Gold Layer
# Creates a comprehensive customer view with lifetime metrics

pipeline: gold_analytics
flowgroup: customer_analytics

actions:
  # Load customers from silver layer
  - name: load_customers_silver
    type: load
    readMode: batch
    source:
      type: delta
      database: "{catalog}.{silver_schema}"
      table: customers
    target: v_customers_silver
    description: "Read customers from silver layer"

  # Load orders from silver layer
  - name: load_orders_silver
    type: load
    readMode: batch
    source:
      type: delta
      database: "{catalog}.{silver_schema}"
      table: orders_enriched
    target: v_orders_silver
    description: "Read enriched orders from silver layer"

  # Create Customer 360 view with lifetime metrics
  - name: transform_customer_360
    type: transform
    transform_type: sql
    source: v_customers_silver
    target: v_customer_360
    sql: |
      WITH customer_orders AS (
        SELECT
          customer_id,
          COUNT(DISTINCT order_id) AS lifetime_orders,
          SUM(total_amount) AS lifetime_revenue,
          AVG(total_amount) AS avg_order_value,
          MIN(order_date) AS first_order_date,
          MAX(order_date) AS last_order_date,
          DATEDIFF(MAX(order_date), MIN(order_date)) AS customer_tenure_days,
          COUNT(DISTINCT product_category) AS categories_purchased
        FROM v_orders_silver
        GROUP BY customer_id
      ),
      customer_segments AS (
        SELECT
          customer_id,
          lifetime_orders,
          lifetime_revenue,
          CASE
            WHEN lifetime_revenue >= 10000 THEN 'VIP'
            WHEN lifetime_revenue >= 5000 THEN 'Gold'
            WHEN lifetime_revenue >= 1000 THEN 'Silver'
            ELSE 'Bronze'
          END AS customer_segment,
          CASE
            WHEN DATEDIFF(CURRENT_DATE(), last_order_date) <= 30 THEN 'Active'
            WHEN DATEDIFF(CURRENT_DATE(), last_order_date) <= 90 THEN 'At Risk'
            ELSE 'Churned'
          END AS engagement_status
        FROM customer_orders
      )
      SELECT
        c.customer_id,
        c.first_name,
        c.last_name,
        c.email,
        c.city,
        c.state,
        c.country,
        c.created_date AS customer_since,
        COALESCE(co.lifetime_orders, 0) AS lifetime_orders,
        COALESCE(co.lifetime_revenue, 0) AS lifetime_revenue,
        COALESCE(co.avg_order_value, 0) AS avg_order_value,
        co.first_order_date,
        co.last_order_date,
        COALESCE(co.customer_tenure_days, 0) AS customer_tenure_days,
        COALESCE(co.categories_purchased, 0) AS categories_purchased,
        COALESCE(cs.customer_segment, 'New') AS customer_segment,
        COALESCE(cs.engagement_status, 'New') AS engagement_status,
        CURRENT_TIMESTAMP() AS _gold_processing_timestamp
      FROM v_customers_silver c
      LEFT JOIN customer_orders co ON c.customer_id = co.customer_id
      LEFT JOIN customer_segments cs ON c.customer_id = cs.customer_id

  # Write as materialized view
  - name: write_customer_360
    type: write
    source: v_customer_360
    write_target:
      type: materialized_view
      database: "{catalog}.{gold_schema}"
      table: customer_360
      properties:
        delta.autoOptimize.optimizeWrite: "true"
    description: "Customer 360 view with lifetime metrics"
